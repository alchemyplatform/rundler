on:
  push:
    branches:
      - main
  pull_request:

name: compliance
jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Rundler
        uses: actions/checkout@v4
        with:
          path: rundler
          submodules: recursive

      - name: Clone Test Executor
        uses: actions/checkout@v4
        with:
          path: ./bundler-test-executors
          repository: alchemyplatform/bundler-test-executor
          ref: releases/v0.6

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup PDM
        uses: pdm-project/setup-pdm@v3

      - run: pip install jq yq

      - run: which xq

      - run: sudo apt-get install -y libxml2-utils

      - name: Build local docker image
        run: docker buildx build ./rundler -t alchemyplatform/rundler:latest

      - name: Run test executor
        run: ./bundler-test-executors/runall.sh local ./bundler-test-executors/bundlers/rundler/rundler.yml

      - name: Parse spec results
        run: ./rundler/.github/scripts/compliance-parser.sh ./bundler-test-executors/build/out/rundler.xml
