on:
  push:
    branches:
      - main
  pull_request:

name: compliance
jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - run: curl -sSL https://raw.githubusercontent.com/pdm-project/pdm/main/install-pdm.py | python3 -
      - run: pip install jq yq
      - run: which xq

      - name: Checkout Rundler
        uses: actions/checkout@v4
        with:
          path: rundler
          submodules: recursive

      - name: Clone Test Executor
        uses: actions/checkout@v4
        with:
          path: ./bundler-test-executors
          repository: alchemyplatform/bundler-test-executor
          ref: releases/v0.6

      - name: Build and test executor
        run: docker buildx build ./rundler -t alchemyplatform/rundler:latest && ./bundler-test-executors/runall.sh local ./bundler-test-executors/bundlers/rundler/rundler.yml

      - name: Parse spec results
        run: ./rundler/.github/scripts/compliance-parser.sh ./bundler-test-executors/build/out/rundler.xml
